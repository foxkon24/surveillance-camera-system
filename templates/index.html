<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, minimum-scale=1, shrink-to-fit=no, user-scalable=no">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.18/hls.js"></script>
    <title>監視カメラシステム</title>
    <style>
        .camera {
            position: relative;
        }
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            color: white;
            background-color: #999;
            z-index: 10;
        }
        .status-streaming { background-color: #4CAF50; }
        .status-connecting { background-color: #2196F3; }
        .status-error { background-color: #F44336; }
        .status-disconnected { background-color: #FF9800; }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .retry-message {
            color: white;
            margin-top: 10px;
            text-align: center;
        }
        .video-controls {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        .control-button {
            padding: 5px 10px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .control-button:hover {
            background-color: #555;
        }
    </style>
    <script>
        // 5分間隔でページを自動更新する関数
        function setupAutoRefresh() {
            setInterval(function() {
                // アクティブなビデオストリームがある場合は更新をスキップ
                const videos = document.getElementsByTagName('video');
                let activeStreams = false;

                for (let video of videos) {
                    if (!video.paused && video.readyState > 2) {
                        activeStreams = true;
                        break;
                    }
                }

                if (!activeStreams) {
                    location.reload();
                }
            }, 300000); // 5分 = 300000ミリ秒
        }

        // ページ読み込み完了時に自動更新を設定
        window.addEventListener('load', function() {
            setupAutoRefresh();
        });
    </script>
</head>
<body>
    <div class="layout">
        <header><h1>監視カメラシステム</h1></header>
        <nav>
            <ul>
                <li><a href="/system/cam/">Top</a></li>
                <li><a href="/system/cam/record/">録画データ</a></li>
                <li><a href="/system/cam/backup/">バックアップ録画一覧</a></li>
            </ul>
        </nav>
        <div class="container">
            <div class="grid">
                {% for camera in cameras %}
                    <div class="camera" id="camera-container-{{ camera.id }}">
                        <h4>{{ camera.name }}</h4>
                        <div class="status-badge" id="status-badge-{{ camera.id }}">準備中...</div>
                        <div class="loading-overlay" id="loading-{{ camera.id }}">
                            <div>
                                <div class="spinner"></div>
                                <div class="retry-message" id="retry-message-{{ camera.id }}">接続中...</div>
                            </div>
                        </div>
                        <div class="video-wrapper">
                            <video id="video{{ camera.id }}" autoplay playsinline muted style="width: 320px; height: 240px;"></video>
                        </div>
                        <div class="video-controls">
                            <button class="control-button" onclick="reloadStream('{{ camera.id }}')">リロード</button>
                            <button class="control-button" onclick="window.open('/system/cam/single?id={{ camera.id }}', '_blank')">拡大表示</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <footer>&nbsp;&nbsp;Copyright&copy;&nbsp;&nbsp;2024&nbsp;&nbsp;株式会社&nbsp;共立電機製作所&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</footer>
    </div>
    <script>
        const players = {};
        const retryAttempts = {};
        const streamTimestamps = {};  // ストリームデータの最終受信時間を追跡
        const MAX_RETRY_ATTEMPTS = 5;
        const RETRY_DELAY = 3000;
        const STREAM_CHECK_INTERVAL = 10000;  // 10秒ごとにストリームをチェック
        const STREAM_STALL_TIMEOUT = 20000;  // 20秒間データが来なければ停止とみなす
        const INITIAL_RETRY_DELAY = 1000;  // 初期再試行遅延
        const MAX_RETRY_DELAY = 10000;  // 最大再試行遅延

        function updateStatusBadge(cameraId, status) {
            const statusBadge = document.getElementById('status-badge-' + cameraId);
            if (!statusBadge) return;
            
            // ステータスによってクラスと表示テキストを変更
            statusBadge.className = 'status-badge';
            
            switch (status) {
                case 'streaming':
                    statusBadge.classList.add('status-streaming');
                    statusBadge.textContent = '接続済';
                    break;
                case 'connecting':
                case 'initializing':
                    statusBadge.classList.add('status-connecting');
                    statusBadge.textContent = '接続中...';
                    break;
                case 'error':
                case 'connection_failed':
                    statusBadge.classList.add('status-error');
                    statusBadge.textContent = 'エラー';
                    break;
                case 'disconnected':
                case 'stalled':
                    statusBadge.classList.add('status-disconnected');
                    statusBadge.textContent = '切断';
                    break;
                default:
                    statusBadge.textContent = status;
            }
        }

        function updateLoadingState(cameraId, isLoading, message = '') {
            const loadingOverlay = document.getElementById('loading-' + cameraId);
            const retryMessage = document.getElementById('retry-message-' + cameraId);
            
            if (loadingOverlay) {
                loadingOverlay.style.display = isLoading ? 'flex' : 'none';
            }
            
            if (retryMessage && message) {
                retryMessage.textContent = message;
            }
        }

        function reloadStream(cameraId) {
            console.log(`Manually reloading stream for camera ${cameraId}`);
            updateStatusBadge(cameraId, 'connecting');
            updateLoadingState(cameraId, true, '再接続中...');
            
            if (players[cameraId]) {
                players[cameraId].destroy();
                players[cameraId] = null;
            }
            
            // リトライカウンタをリセット
            retryAttempts[cameraId] = 0;
            
            // 少し待ってから再初期化
            setTimeout(() => initializePlayer(cameraId), 1000);
        }

        function initializePlayer(cameraId) {
            const video = document.getElementById('video' + cameraId);
            if (!video) {
                console.error(`Video element for camera ${cameraId} not found`);
                return;
            }

            const filePath = '/system/cam/tmp/' + cameraId + '/' + cameraId + '.m3u8';

            if (players[cameraId]) {
                players[cameraId].destroy();
            }

            // 再試行回数の追跡
            if (typeof retryAttempts[cameraId] === 'undefined') {
                retryAttempts[cameraId] = 0;
            }

            // 読み込み中の表示
            updateLoadingState(cameraId, true, '接続中...');
            updateStatusBadge(cameraId, 'connecting');
            
            streamTimestamps[cameraId] = Date.now();  // 初期化時のタイムスタンプを記録

            if (Hls.isSupported()) {
                const hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 30,
                    maxBufferLength: 10,
                    maxMaxBufferLength: 20,
                    xhrSetup: function(xhr, url) {
                        // タイムスタンプをURLに追加してキャッシュを防止
                        if (url.includes('.m3u8')) {
                            url = url + (url.includes('?') ? '&' : '?') + '_t=' + Date.now();
                            xhr.open('GET', url, true);
                        }
                    },
                    // タイムアウト設定を調整
                    manifestLoadingTimeOut: 10000,
                    manifestLoadingMaxRetry: 3,
                    manifestLoadingRetryDelay: 1000,
                    levelLoadingTimeOut: 10000,
                    levelLoadingMaxRetry: 3,
                    levelLoadingRetryDelay: 1000,
                    fragLoadingTimeOut: 10000,
                    fragLoadingMaxRetry: 3,
                    fragLoadingRetryDelay: 1000
                });

                players[cameraId] = hls;

                hls.loadSource(filePath);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    // 再生の開始時にエラーが発生した場合はミュートで再試行
                    video.play().catch(function(error) {
                        console.log(`Camera ${cameraId} autoplay failed:`, error);
                        video.muted = true;
                        video.play();
                    });
                    
                    updateStatusBadge(cameraId, 'streaming');
                    updateLoadingState(cameraId, false);
                });

                // フラグメントロード成功時にタイムスタンプを更新
                hls.on(Hls.Events.FRAG_LOADED, function() {
                    streamTimestamps[cameraId] = Date.now();
                    updateStatusBadge(cameraId, 'streaming');
                    updateLoadingState(cameraId, false);
                });

                // エラーハンドリング
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.log(`Camera ${cameraId} HLS error:`, data);
                    
                    // m3u8ファイルが見つからない場合のメッセージを更新
                    if (data.response && data.response.code === 404) {
                        updateLoadingState(cameraId, true, 'ストリーム準備中...');
                        updateStatusBadge(cameraId, 'initializing');
                    }

                    if (data.fatal) {
                        updateStatusBadge(cameraId, 'error');
                        updateLoadingState(cameraId, true, 'エラー発生 - 再接続中...');

                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log(`Camera ${cameraId} network error, attempting recovery...`);
                                
                                // 指数バックオフを使用した再試行
                                const currentRetry = retryAttempts[cameraId]++;
                                const delay = Math.min(INITIAL_RETRY_DELAY * Math.pow(2, currentRetry), MAX_RETRY_DELAY);
                                
                                updateLoadingState(cameraId, true, `再接続中... (${currentRetry+1}回目)`);
                                
                                if (currentRetry < MAX_RETRY_ATTEMPTS) {
                                    setTimeout(() => {
                                        hls.startLoad();
                                    }, delay);
                                } else {
                                    updateLoadingState(cameraId, true, 'ストリーム読込失敗 - リロードしてください');
                                }
                                break;
                                
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log(`Camera ${cameraId} media error, attempting recovery...`);
                                updateLoadingState(cameraId, true, 'メディアエラー - 修復中...');
                                hls.recoverMediaError();
                                break;
                                
                            default:
                                const currentRetry = retryAttempts[cameraId]++;
                                if (currentRetry < MAX_RETRY_ATTEMPTS) {
                                    const delay = Math.min(INITIAL_RETRY_DELAY * Math.pow(2, currentRetry), MAX_RETRY_DELAY);
                                    updateLoadingState(cameraId, true, `エラー - 再接続中... (${currentRetry+1}回目)`);
                                    setTimeout(() => initializePlayer(cameraId), delay);
                                } else {
                                    updateLoadingState(cameraId, true, 'ストリーム読込失敗 - リロードしてください');
                                }
                                break;
                        }
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // ネイティブHLSサポート（Safari）
                video.src = filePath;
                video.addEventListener('loadedmetadata', function() {
                    video.play().catch(function(error) {
                        console.log(`Camera ${cameraId} autoplay failed:`, error);
                        video.muted = true;
                        video.play();
                    });
                    updateStatusBadge(cameraId, 'streaming');
                    updateLoadingState(cameraId, false);
                });
                
                // エラーハンドリング
                video.addEventListener('error', function(e) {
                    console.error(`Native HLS player error for camera ${cameraId}:`, video.error);
                    updateStatusBadge(cameraId, 'error');
                    updateLoadingState(cameraId, true, 'ビデオエラー - リロードしてください');
                });
            } else {
                // HLS非対応ブラウザ
                updateLoadingState(cameraId, true, 'このブラウザはHLSをサポートしていません');
                console.error('This browser does not support HLS');
            }
        }

        // ストリーミングの健全性チェック
        function setupHealthChecks() {
            {% for camera in cameras %}
            setInterval(() => {
                const cameraId = '{{ camera.id }}';
                const video = document.getElementById('video' + cameraId);
                const player = players[cameraId];
                const currentTime = Date.now();
                const lastUpdateTime = streamTimestamps[cameraId] || 0;
                
                // プレイヤーが存在しない場合は初期化
                if (!player) {
                    console.log(`Camera ${cameraId} player not initialized, attempting to initialize...`);
                    initializePlayer(cameraId);
                    return;
                }
                
                // 再生状態チェック - readyState 0はストリームが読み込まれていない状態
                if (video && video.readyState === 0) {
                    console.log(`Camera ${cameraId} stream not loaded, attempting recovery...`);
                    updateStatusBadge(cameraId, 'disconnected');
                    updateLoadingState(cameraId, true, '接続中...');
                    reloadStream(cameraId);
                    return;
                }
                
                // データ受信チェック - 一定時間データが来ていなければ再接続
                if (currentTime - lastUpdateTime > STREAM_STALL_TIMEOUT) {
                    console.log(`Camera ${cameraId} stream stalled (no data for ${(currentTime - lastUpdateTime)/1000}s), reloading...`);
                    updateStatusBadge(cameraId, 'stalled');
                    updateLoadingState(cameraId, true, 'ストリーム停止 - 再接続中...');
                    reloadStream(cameraId);
                    return;
                }
                
            }, STREAM_CHECK_INTERVAL);
            {% endfor %}
        }

        window.onload = function() {
            {% for camera in cameras %}
                initializePlayer('{{ camera.id }}');
            {% endfor %}
            
            // 健全性チェックを設定
            setupHealthChecks();
        };

        // バックグラウンド切り替え時の処理
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // バックグラウンドに移行した場合、各ストリームを一時停止
                for (const cameraId in players) {
                    if (players[cameraId]) {
                        players[cameraId].stopLoad();
                    }
                }
            } else {
                // フォアグラウンドに戻った場合、各ストリームを再開
                for (const cameraId in players) {
                    if (players[cameraId]) {
                        players[cameraId].startLoad();
                        streamTimestamps[cameraId] = Date.now(); // タイムスタンプを更新
                    }
                }
            }
        });

        // クリーンアップ
        window.addEventListener('beforeunload', function() {
            for (const cameraId in players) {
                if (players[cameraId]) {
                    players[cameraId].destroy();
                }
            }
        });
    </script>
</body>
</html>
